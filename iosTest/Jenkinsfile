
start()

def start() {
  testAcceptance() 
}

def testAcceptance() {
  node('acceptance') {
    env.LANG = "en_US.UTF-8"
    env.LANGUAGE = "en_US.UTF-8"
    env.LC_ALL = "en_US.UTF-8"

    stage ('Clean & Git checkout') {
      deleteDir()
      checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github', url: 'https://github.com/blacklane/cassandra/']]])
      echo 'Workspace is at: ' + env.BUILD_URL + 'execution/node/3/ws/'
    }
    stage ('Start iOS tests') {
      timeout(time: 90, unit: 'MINUTES') {
        echo 'Running iOS tests...'
        try {
          BUILD_STATUS = sh ( 
            script: "xcodebuild -workspace Blacklane.xcworkspace -scheme BlacklaneAcceptanceTests -destination 'platform=iOS Simulator,name=iPhone 7' test | " +
                    "tee test_results.log | " +
                    "xcpretty --report html --output test_results.html",
            returnStdout: true 
          )
          if (BUILD_STATUS.contains("failed")) {
            echo 'Acceptance test(s) failed'
            error('Acceptance test(s) failed')
          }
        } catch (err) {
          echo 'Sending build failure email'
          sendBuildFailureEmail(err)
        } finally {
          echo 'Killing the simulator...'
          sh "killall \"Simulator\""
        }
      }
    }
  }
}

/**
 * Invoked when any build process fails.
 * An email will be sent to the 'committer email' on the last commit.
 */
def sendBuildFailureEmail(err) {
  node('acceptance') {
    $subject = 'Cassandra Acceptance Tests have failed'
    $body = '<p>Check failure using link ' + env.BUILD_URL + '</p><p>HTML Report: ' + env.BUILD_URL + 'execution/node/3/ws/test_results.html</p><p>Text Log Report: ' + env.BUILD_URL + 'execution/node/3/ws/test_results.log</p>'
    $to = ('sofia.vistas@blacklane.com, matthew.bogott@blacklane.com')
    emailext attachLog:false, body:$body, subject:$subject, to:$to, mimeType:'text/html'
    error(err.getMessage())
  }
}
