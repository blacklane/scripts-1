TEST_PACKAGE="com.blacklane.passenger.test.acceptance"
RUNNER="com.blacklane.passenger.test.RxJUnitRunner"
APP_ID="com.blacklane.passenger.dev"

EMULATOR_PORT="5584"// must be an even number between 5554-5584

EMULATOR_ID="emulator-${EMULATOR_PORT}"

EMULATOR_AVD="Nexus_5X_API_25_Acceptance_Tests"


start()
def start() {
  try {
   testAcceptance()
  } finally {
      sendBuildEmail()
  }
} 

def testAcceptance() {
  node('acceptance') {
    stage ('Clean & Git checkout') {
      deleteDir()
      checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github', url: 'https://github.com/blacklane/pepper/']]])
      echo 'Workspace is at: ' + env.BUILD_URL + 'execution/node/3/ws/'
    }
    stage ('Start emulators and results folder') {
      sh "curl https://raw.githubusercontent.com/blacklane/zulu-scripts/master/androidTest/wait_for_emulator.sh -o wait_for_emulator.sh"
      sh "chmod +x wait_for_emulator.sh"
      sh "./wait_for_emulator.sh ${EMULATOR_PORT} ${EMULATOR_AVD}"
      sh "mkdir -p results"
    }
    stage ('Run tests') {
      timeout(time: 40, unit: 'MINUTES') {

        echo "Running acceptance tests..."
        try {
          sh "./gradlew spoon"
        } catch(err) {
        
        }
        echo "Copying results to the folder..."
        sh "cp -r app/build/spoon results"
      }    
    }
    stage ('Assemble email report') {
      echo "Sending report"

      sh "curl https://raw.githubusercontent.com/blacklane/zulu-scripts/master/androidTest/email_report_builder.py -o email_report_builder.py"
      sh "touch email-report.html"
      sh "python email_report_builder.py"
    }
  }
}

def sendBuildEmail() {
  node('acceptance') {
    $subject = 'Pepper Acceptance Tests daily digest!'
    $body = readFile 'email-report.html'
    $to = ('sofia.vistas@blacklane.com, matthew.bogott@blacklane.com')
    emailext attachLog:false, body:$body, subject:$subject, to:$to, mimeType:'text/html'
 
  }
}
